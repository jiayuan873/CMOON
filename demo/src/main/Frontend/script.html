<!DOCTYPE html>
<html>
<head>
  <title>STL to STEP Converter</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
  <link rel="stylesheet" href="style.css"/>
</head>

<body>
  
  <nav class="navbar navbar-expand-lg bg-body-tertiary fixed-top">
    <div class="container-fluid">
      <span class="navbar-text">
        <div class="slidetextRIGHT">

          <h1>STL to STEP Converter</h1>
            
        </div>
      </span>
      <div class="d-flex align-items-center gap-3">
        <div class="slidetextLEFT" style="animation-delay: 0.4s;">
          <button class="btn btn-primary">About Us</button>
        </div>
        <div class="slidetextLEFT" style="animation-delay: 0.7s;">
          <button class="btn btn-primary">Resources</button>
        </div>
      </div>
    </div>
  </nav>

<div id="loadingSpinner" class="mt-3" style="display: none;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Importing...</span>
  </div>
  <p class="mt-2">Uploading to Onshape, please wait...</p>
</div>

  <div class="container text-center mt-4">
    <div class="drop-zone mx-auto mb-3" id="dropZone">
      <div class="fade-in">
        <span id="dropText">Drag & drop STL file here<br>or click to upload</span>
        <input type="file" id="fileInput" hidden>
      </div>
    </div>

    <div class="d-flex justify-content-center gap-2">
   <button type="button" class="btn btn-secondary" id="runBtn">Import to Onshape</button>
<button type="button" class="btn btn-secondary" id="convertBtn">Convert to STEP</button>
    </div>
  </div>

  <div id="output" class="mt-3"></div>

  <div>
    <div class="wave"></div>
    <div class="wave"></div>
    <div class="wave"></div>
  </div>

<div id = "overlay"></div>

  <!-- JavaScript -->
  <script>
    let uploadedFile = null;  
  window.onbeforeunload = null; 

  document.addEventListener("DOMContentLoaded", () => {
window.onbeforeunload = () => false;
document.querySelectorAll('button').forEach(btn => {
  btn.addEventListener('click', e => e.preventDefault());
});

document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', e => e.preventDefault());
  });                                                                                           

    document.getElementById('runBtn').onclick = runScript;

    document.getElementById('convertBtn').addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      runConversion(e);
    });

    document.querySelectorAll('a[href="#"]').forEach(a => {
      a.addEventListener('click', function(e) {
        e.preventDefault();
      });
    });

      const dropZone = document.getElementById("dropZone");
      const fileInput = document.getElementById("fileInput");

      dropZone.addEventListener("click", () => fileInput.click());

      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("dragover");
      });

      dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("dragover");
      });

      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("dragover");
        handleFiles(e.dataTransfer.files);
      });

      fileInput.addEventListener("change", () => {
        handleFiles(fileInput.files);
      });
    });

    function handleFiles(files) {
      if (!files.length) return;
      uploadedFile = files[0];
      document.getElementById("dropText").innerHTML = `Uploaded: ${uploadedFile.name}`;
    }

  function runScript() {
  const spinner = document.getElementById('loadingSpinner');
  const output = document.getElementById('output');

  // Show the spinner
  spinner.style.display = 'block';
  overlay.style.display = 'block';
  output.innerHTML = '';
  

  fetch('http://127.0.0.1:3000/run-script')
    .then(response => {
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return response.text();
    })
    .then(outputText => {
      // Hide spinner and show result
      spinner.style.display = 'none';
      overlay.style.display = 'none';

    })
    .catch(err => {
      spinner.style.display = 'none';
      output.innerHTML = `<div class="text-danger">❌ Error: ${err.message}</div>`;
      console.error(err);
    });
}

let convertedBlob = null;

function runConversion(e) {
  e.preventDefault();
  e.stopPropagation(); // prevent reload

  if (!uploadedFile) {
    alert("Please upload an STL file first.");
    return;
  }

  const formData = new FormData();
  formData.append('stlFile', uploadedFile);

  fetch('http://127.0.0.1:3000/convert', {  // ✅ match backend IP
    method: 'POST',
    body: formData,
  })
    .then(response => {
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return response.blob();
    })
    .then(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'converted.step';
      a.click();
      a.remove();
      
    })
    .catch(err => {
      console.error("❌ Conversion error:", err);
      document.getElementById('output').innerHTML = `❌ Conversion failed: ${err.message}`;
    });
}

function downloadFile() {
  if (!convertedBlob) {
    alert("No file converted yet. Please click 'Convert to STEP' first.");
    return;
  }
  const url = window.URL.createObjectURL(convertedBlob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'converted.step';
  document.body.appendChild(a);
  a.click();
  a.remove();
}
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
